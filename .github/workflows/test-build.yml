name: build-test-release

on:
  push:
    branches: ["main"]

jobs:
  build-test-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: mbstring

      - name: Verify PHP version
        run: php -v

      - name: Download PocketMine-MP Stable
        run: |
          wget -O pmmp.phar "https://update.pmmp.io/api?channel=stable"
          ls -lah
          file pmmp.phar

      - name: Generate Plugin Version
        id: setver
        run: |
          DATE=$(date +"%Y.%m.%d.%H%M")
          echo "version=$DATE" >> $GITHUB_OUTPUT
          sed -i "s/version: .*/version: $DATE/" plugin.yml
          echo "Generated version: $DATE"

      - name: Run Tests
        run: |
          php -l src/Translator.php
          php -l src/PacketMapper.php
          php -l src/VersionTable.php
          php -l src/Main.php

      - name: Build Plugin PHAR
        run: |
          mkdir -p build
          php pmmp.phar --make-plugin . build/OmniVersion.phar

      - name: List Build Output
        run: ls -lah build

      # ==================================================
      # CREATE GIT TAG OTOMATIS
      # ==================================================
      - name: Create Git Tag
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          TAG="v${{ steps.setver.outputs.version }}"
          git tag $TAG
          git push origin $TAG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================================================
      # CREATE GITHUB RELEASE
      # ==================================================
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.setver.outputs.version }}
          name: "OmniVersion v${{ steps.setver.outputs.version }}"
          draft: false
          prerelease: false
          files: |
            build/OmniVersion.phar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}