name: OmniVersion Hybrid Build

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build-test-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: mbstring

      - name: Verify PHP version
        run: php -v

      # ===============================================
      # DOWNLOAD POCKETMINE (STABLE)
      # ===============================================
      - name: Download PocketMine-MP Stable
        run: |
          wget -O pmmp.phar "https://update.pmmp.io/api?channel=stable"
          ls -lah
          file pmmp.phar

      # ===============================================
      # AUTO VERSIONING
      # ===============================================
      - name: Generate Plugin Version
        id: setver
        run: |
          DATE=$(date +"%Y.%m.%d.%H%M")
          echo "version=$DATE" >> $GITHUB_OUTPUT
          echo "Generated version: $DATE"

          # Update plugin.yml
          sed -i "s/version: .*/version: $DATE/" plugin.yml

      # ===============================================
      # RUN UNIT TESTS
      # ===============================================
      - name: Run Tests
        run: |
          if [ -d "tests" ]; then
            echo "Running tests..."
            php -l src/Translator.php
            php -l src/PacketMapper.php
            php -l src/VersionTable.php
            php -l src/Main.php
          else
            echo "No tests folder found. Skipping..."
          fi

      # ===============================================
      # BUILD PLUGIN PHAR
      # ===============================================
      - name: Build Plugin PHAR
        run: |
          mkdir -p build
          php pmmp.phar --make-plugin . build/OmniVersion.phar

      - name: List Build Output
        run: ls -lah build

      # ===============================================
      # AUTO RELEASE
      # ===============================================
      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v${{ steps.setver.outputs.version }}
          name: "OmniVersion v${{ steps.setver.outputs.version }}"
          draft: false
          prerelease: false
          files: |
            build/OmniVersion.phar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}