name: OmniVersion Hybrid Build

on:
  push:
    branches: ["main"]
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: mbstring, xml, curl, yaml, sqlite3
          coverage: none

      - name: Verify PHP version
        run: php -v

      - name: Download PocketMine-MP
        run: |
          mkdir -p pmmp
          wget https://github.com/pmmp/PocketMine-MP/releases/latest/download/PocketMine-MP.phar -O pmmp/PocketMine-MP.phar

      - name: Install Composer
        run: |
          EXPECTED_SIGNATURE=$(wget -q -O - https://composer.github.io/installer.sig)
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          ACTUAL_SIGNATURE=$(php -r "echo hash_file('sha384', 'composer-setup.php');")

          if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ]; then
            echo "ERROR: Invalid Composer installer signature"
            exit 1
          fi

          php composer-setup.php --quiet
          rm composer-setup.php
          mv composer.phar /usr/local/bin/composer

      - name: Composer install
        run: composer install --no-dev

      - name: Build plugin PHAR
        run: |
          php build/build.php
          mv OmniVersion.phar build/OmniVersion.phar

      - name: Upload PHAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: OmniVersion-Build
          path: build/OmniVersion.phar